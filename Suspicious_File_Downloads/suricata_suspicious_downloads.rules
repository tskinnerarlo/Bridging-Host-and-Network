# suspicious_downloads.v3.rules (Suricata 7.0.7)
# Fixes: replace http.response_headers (unknown in your build) with http.header,
#        use built-in classtype, keep sticky-buffer semantics.
# Notes:
#  - http.header works for both request and response headers; we constrain with flow:to_client.
#  - If 'filemagic' isn't available, you can use the commented MZ fallback rule below.

# 1) Windows PE over HTTP (preferred: filemagic)
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious download: Windows PE executable over HTTP";flow:to_client,established;filemagic:"^PE32";classtype:potentially-bad-traffic;metadata:attack_target Client, deployment Perimeter;sid:2501301; rev:1;)

#    Fallback for builds without libmagic support (comment out rule above if needed)
# alert http $EXTERNAL_NET any -> $HOME_NET any (
#   msg:"Suspicious download: Windows PE executable over HTTP (MZ header)";
#   flow:to_client,established;
#   http.response_body; content:"MZ"; depth:2;
#   classtype:potentially-bad-traffic;
#   metadata:attack_target Client, deployment Perimeter;
#   sid:2501301; rev:2;
# )

# 2) Attachment with executable extensions via Content-Disposition filename=
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious download: attachment with executable extension";flow:to_client,established;http.header; content:"Content-Disposition"; nocase; content:"attachment"; nocase; pcre:"/filename\s*=\s*\"?[^\"\s]+\.(exe|dll|msi|ps1|bat|vbs|js)\"?/i";classtype:potentially-bad-traffic;metadata:attack_target Client, deployment Perimeter;sid:2501302; rev:1;)

# 3) Attachment with common archive extensions
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious download: archive type (zip|rar|7z) attachment";flow:to_client,established;http.header; content:"Content-Disposition"; nocase; content:"attachment"; nocase; pcre:"/filename\s*=\s*\"?[^\"\s]+\.(zip|rar|7z)\"?/i";classtype:potentially-bad-traffic;metadata:attack_target Client, deployment Perimeter;sid:2501303; rev:1;)
