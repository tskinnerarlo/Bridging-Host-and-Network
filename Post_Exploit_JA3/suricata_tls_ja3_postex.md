# Post Exploit JA3 Suricata rules
Below is a  Suricata ruleset that alerts on TLS JA3 hashes linked to common post-exploitation/C2 tools, plus why each rule works, how to deploy, and simple ways to test (pcap replay or a quick “plumbing” self-test).

I’ve used Suricata’s modern JA3 keywords (ja3.hash / ja3s.hash) and included a dataset-driven rule so you can maintain a list without editing rules every time. (JA3/JA4 keyword syntax and enablement are documented by OISF. 
[Suricata User Guide - https://docs.suricata.io/en/latest/rules/ja-keywords.html])

# Suricata rules (save as ```tls_ja3_postex.rules```)
Tweak the JA3 list as you like. All hashes are MD5 in lowercase.
These rules assume a typical egress direction: ```$HOME_NET → $EXTERNAL_NET```.
```suricata
###############################################################################
# JA3: Post-exploitation / C2 frameworks (client hellos)
# Notes:
#  - JA3 is not unique: expect collisions. Pairing with JA3S reduces FPs.
#  - Some frameworks randomize or can mimic browsers; use as hunting signals.
###############################################################################

# 220101 — Cobalt Strike common JA3 (client); seen widely in CS beacons
# Sources: DFIR/others report frequent CS use of 72a589da... (also used by other malware),
# and training material shows pairing with specific JA3S to reduce FPs. 
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3: probable Cobalt Strike client (72a589da...)";
    flow:established,to_server;
    ja3.hash; content:"72a589da586844d7f0818ce684948eea";
    classtype:trojan-activity;
    reference:url:thedfirreport.com/2022/01/24/cobalt-strike-a-defenders-guide-part-2/;
    sid:220101; rev:1;
)

# 220102 — Cobalt Strike (JA3 + JA3S combo) for higher confidence
# Commonly reported combos (example JA3S shown below).
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3+JA3S: probable Cobalt Strike (higher confidence)";
    flow:established,to_server;
    ja3.hash; content:"72a589da586844d7f0818ce684948eea";
    ja3s.hash; content:"b742b407517bac9536a77a7b0fee28e9";
    classtype:trojan-activity;
    reference:url:redsiege.com/wp-content/uploads/2021/09/20210914-SIEGECAST-COBALT-STRIKE-BASICS.pdf;
    sid:220102; rev:1;
)

# 220103 — Metasploit / Meterpreter (Linux example JA3 from Salesforce post)
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3: Metasploit Meterpreter (Linux) (5d65ea3f...)";
    flow:established,to_server;
    ja3.hash; content:"5d65ea3fb1d4aa7d826733d2f2cbbb1d";
    classtype:trojan-activity;
    reference:url:engineering.salesforce.com/open-sourcing-ja3-92c9e53c3c41/;
    sid:220103; rev:1;
)

# 220104 — Metasploit combo: alternative client + JA3S
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3+JA3S: probable Metasploit (a0e9f5d6... + 70999de6...)";
    flow:established,to_server;
    ja3.hash; content:"a0e9f5d64349fb13191bc781f81f42e1";
    ja3s.hash; content:"70999de61602be74d4b25185843bd18e";
    classtype:trojan-activity;
    reference:url:redsiege.com/wp-content/uploads/2021/09/20210914-SIEGECAST-COBALT-STRIKE-BASICS.pdf;
    sid:220104; rev:1;
)

# 220105 — Sliver C2 (Go TLS default style JA3 frequently reported in-the-wild)
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3: Sliver (Go TLS) (19e29534...)";
    flow:established,to_server;
    ja3.hash; content:"19e29534fd49dd27d09234e639c4057e";
    classtype:trojan-activity;
    reference:url:darktrace.com/blog/sliver-c2-how-darktrace-provided-a-sliver-of-hope-in-the-face-of-an-emerging-c2-framework;
    sid:220105; rev:1;
)

# 220106 — Empire / PoshC2 (Python TLS stacks often show this JA3)
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3: Python client often used by Empire/PoshC2 (db42e301...)";
    flow:established,to_server;
    ja3.hash; content:"db42e3017c8b6d160751ef3a04f695e7";
    classtype:trojan-activity;
    reference:url:thedfirreport.com/2022/01/24/cobalt-strike-a-defenders-guide-part-2/;
    sid:220106; rev:1;
)

###############################################################################
# 220110 — Dataset-driven rule (use Abuse.ch SSLBL/your own list)
# Keep a maintainable external list of JA3 md5 hashes (one per line).
# See deployment steps below to build/load 'postex-ja3.lst'.
###############################################################################
alert tls $HOME_NET any -> $EXTERNAL_NET any (
    msg:"TLS JA3: match in local dataset (post-ex/C2)";
    flow:established,to_server;
    ja3.hash; dataset:isset,postex-ja3, type md5, load postex-ja3.lst, memcap 10mb, hashsize 2048;
    classtype:trojan-activity;
    reference:url:sslbl.abuse.ch/ja3-fingerprints/;
    sid:220110; rev:1;
)
```
**Why these work**

- **JA3 matches the TLS ClientHello fingerprint** (cipher suites, extensions, etc.). Many C2 frameworks ship with characteristic TLS stacks or defaults, which produce stable JA3 hashes across campaigns—until the operator changes profiles or the tool randomizes. (Suricata JA3/JA4 rule syntax & enablement: ```ja3.hash```, ```ja3s.hash```, ```app-layer.protocols.tls.ja3-fingerprints: yes.```) 
[Suricata User Guide - https://docs.suricata.io/en/latest/rules/ja-keywords.html]

- Combining ```ja3.hash``` + ```ja3s.hash``` (server-side JA3S of the ServerHello) tightens confidence, as shown in blue-team training for Cobalt Strike and Metasploit. 
[redsiege.com - https://www.redsiege.com/wp-content/uploads/2021/09/20210914-SIEGECAST-COBALT-STRIKE-BASICS.pdf?]

- Specific post-ex/campaign examples for the hashes above are documented by DFIR Report, Darktrace, and Salesforce/JA3 posts. 
The DFIR Report [https://thedfirreport.com/2022/01/24/cobalt-strike-a-defenders-guide-part-2/]
Salesforce Engineering Blog[https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967]
[redsiege.com - https://www.redsiege.com/wp-content/uploads/2021/09/20210914-SIEGECAST-COBALT-STRIKE-BASICS.pdf?]

- A dataset rule lets you maintain a living list (e.g., from abuse.ch SSLBL JA3 feed or your own intel). Suricata supports loading a list and checking any sticky buffer (here, ja3.hash) with dataset:isset. 
Suricata User Guide

⚠️ Reality check: JA3 ≠ attribution. Popular hashes collide with benign apps or other malware, and modern C2s can randomize/mimic browser stacks. Use these as hunting signals, not block-on-sight, unless combined with more context (JA3S, SNI, cert, flow behavior).

# Implementation steps

**1. Enable JA3/JA3S in Suricata**

- In ```suricata.yaml```, ensure:
```yaml
app-layer:
  protocols:
    tls:
      enabled: yes
      # JA3/JA4 will auto-enable if a rule needs it, but set explicitly:
      ja3-fingerprints: yes
```
- OISF docs note JA3/JA4 support can also be compile-time-toggled; you can guard your rules with requires: feature ja3; if needed. [Suricata User Guide - https://docs.suricata.io/en/latest/rules/ja-keywords.html]

**2. Install rules**

- Save the block above as tls_ja3_postex.rules, then add to suricata.yaml under rule-files: and reload Suricata.

**3. (Optional, recommended) Build the dataset for rule 220110**

Download a JA3 feed (e.g., SSLBL JA3 blacklist CSV) and convert to a one-per-line md5 list:
```bash
curl -fsS -o /etc/suricata/rules/postex-ja3.csv https://sslbl.abuse.ch/blacklist/ja3_fingerprints.csv
# Keep column 1 (JA3 md5), drop header/blanks:
awk -F, 'NR>1 && $1 ~ /^[0-9a-f]{32}$/ {print tolower($1)}' /etc/suricata/rules/postex-ja3.csv \
  | sort -u > /etc/suricata/rules/postex-ja3.lst
```
- The dataset rule loads ```postex-ja3.lst``` directly and uses reasonable ```memcap/hashsize```. (Dataset usage & file format: OISF docs.) 
[Suricata User Guide - https://docs.suricata.io/en/latest/rules/datasets.html]

- SSLBL provides both a JA3 CSV and a prebuilt Suricata ruleset if you prefer to include theirs as-is. Beware FPs as noted by SSLBL.[SSL Blacklist - https://sslbl.abuse.ch/blacklist/ ]

# How to test (two easy paths)

**Quick “plumbing” self-test (no malware/tools required)**

Find your own JA3 by hitting a fingerprinting site from the test host (e.g., ja3er [https://xsoar.pan.dev/docs/reference/integrations/ja3er]) and note the md5.

* Temporarily replace one rule’s hash with your JA3.

* Generate any TLS traffic (browse to any HTTPS site).

* Confirm Suricata alerts in eve.json.
  
This validates JA3 extracton + rule matching without needing a specific C2 tool. 
<br> [JA3 concept/introduction from Salesforce: https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967/]

Check alerts:
```bash
jq 'select(.alert and .event_type=="alert") | {ts:.timestamp, sig:.alert.signature, ja3:(.tls.ja3.hash // .ja3?.hash)}' /var/log/suricata/eve.json
```
**Replay a public PCAP that includes Cobalt Strike**

* Grab a CS pcap from Malware-Traffic-Analysis (for example, 2023-10-03 or 2024-04-18 posts have CS traffic). 
[malware-traffic-analysis.net https://www.malware-traffic-analysis.net/2023/10/03/index.html]


* Run Suricata in offline/pcap mode with your rules:
```bash
suricata -r /path/to/CS.pcap -S /etc/suricata/rules/tls_ja3_postex.rules -l /tmp/eve
jq 'select(.alert) | {sig:.alert.signature, ja3:(.tls.ja3.hash // .ja3?.hash), ja3s:(.tls.ja3s.hash // .ja3s?.hash)}' /tmp/eve/eve.json
```
* You should see alerts for 220101/220102 depending on what the pcap contains (common CS JA3 and/or JA3S). (Multiple public write-ups list CS JA3 72a589da… and example JA3S.) [https://thedfirreport.com/2022/05/09/seo-poisoning-a-gootloader-story/ https://www.redsiege.com/wp-content/uploads/2021/09/20210914-SIEGECAST-COBALT-STRIKE-BASICS.pdf]

# Tuning ideas
* Lower false positives by requiring JA3 + JA3S (as in 220102/220104), and/or scoping to egress only. (We already use ```flow:established```,to_server.) 
[Suricata User Guide: https://docs.suricata.io/en/latest/rules/ja-keywords.html]

* Pair with other TLS signals: ```tls.sni``` (known bad infra), tls.```cert_*``` (default/self-signed traits), or **JARM/JA4** where available. (JA4 support exists in Suricata; add ```ja4.hash``` if helpful.) 
[Suricata User Guide: https://docs.suricata.io/en/latest/rules/ja-keywords.html]

* Use a dataset for rotating intel and keep the static rules for high-confidence anchors. (Datasets guide.) 
[Suricata User Guide: https://docs.suricata.io/en/latest/rules/datasets.html]

* Remember that many C2s can randomize TLS; treat these as hunting signatures, not definitive attribution.[https://github.com/salesforce/ja3]

# Sources & references
* Suricata rule syntax for JA3/JA3S/JA4 and enablement. 
[Suricata User Guide: https://docs.suricata.io/en/latest/rules/ja-keywords.html]

* Cobalt Strike JA3/JA3S combos (training slide). 
[redsiege.com: https://www.redsiege.com/wp-content/uploads/2021/09/20210914-SIEGECAST-COBALT-STRIKE-BASICS.pdf?]

* DFIR Report: Python JA3 used with Empire/PoshC2; general CS JA3 mentions. 
[The DFIR Report: https://thedfirreport.com/2022/01/24/cobalt-strike-a-defenders-guide-part-2/]

* Darktrace: Sliver C2 with Go-TLS JA3 example. 
[Darktrace: https://www.darktrace.com/blog/sliver-c2-how-darktrace-provided-a-sliver-of-hope-in-the-face-of-an-emerging-c2-framework]

* Salesforce (JA3) post: Meterpreter JA3 example. 
[Salesforce Engineering Blog: https://engineering.salesforce.com/open-sourcing-ja3-92c9e53c3c41/]

* abuse.ch SSLBL: JA3 blacklist & Suricata JA3 ruleset. 
[SSL Blacklist: https://sslbl.abuse.ch/blacklist/]