<Sysmon schemaversion="4.50">
  <EventFiltering>

    <!-- ===========================================================
         PROCESS CREATE (Event ID 1)
         Capture execution context for common C2/upload tools and
         anything launched from temp-like dirs (living-off-the-land).
         =========================================================== -->
    <ProcessCreate onmatch="include">

      <!-- Net/transfer tooling frequently used in staging/exfil -->
      <RuleGroup name="NetTools_Exec" groupRelation="or">
        <Image condition="end with">/curl</Image>
        <Image condition="end with">/wget</Image>
        <Image condition="end with">/python</Image>
        <Image condition="end with">/python3</Image>
        <Image condition="end with">/openssl</Image>
        <Image condition="end with">/socat</Image>
        <Image condition="end with">/ncat</Image>
        <Image condition="end with">/nc</Image>
      </RuleGroup>

      <!-- Suspicious execution locations -->
      <RuleGroup name="Tmp_Exec" groupRelation="and">
        <Image condition="contains any">/tmp/|/dev/shm/|/var/tmp/</Image>
      </RuleGroup>

      <!-- Heuristic: obvious upload/HTTP flags (helps triage) -->
      <RuleGroup name="Upload_Flags" groupRelation="and">
        <CommandLine condition="contains any">--data-binary @|-d @|--upload-file|-T|-F|--form|https://</CommandLine>
      </RuleGroup>
    </ProcessCreate>

    <!-- ===========================================================
         NETWORK CONNECT (Event ID 3)
         Attribute outbound connections to the originating process.
         =========================================================== -->
    <NetworkConnect onmatch="include">

      <!-- Any egress from our short list of net tools -->
      <RuleGroup name="NetTools_Egress" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <Image condition="end with">/curl</Image>
      </RuleGroup>
      <RuleGroup name="NetTools_Egress" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <Image condition="end with">/wget</Image>
      </RuleGroup>
      <RuleGroup name="NetTools_Egress" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <Image condition="end with">/python3</Image>
      </RuleGroup>
      <RuleGroup name="NetTools_Egress" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <Image condition="end with">/openssl</Image>
      </RuleGroup>
      <RuleGroup name="NetTools_Egress" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <Image condition="end with">/socat</Image>
      </RuleGroup>
      <RuleGroup name="NetTools_Egress" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <Image condition="end with">/ncat</Image>
      </RuleGroup>

      <!-- Common TLS ports (optional narrowing) -->
      <RuleGroup name="TLSish_Ports" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <DestinationPort condition="is">443</DestinationPort>
      </RuleGroup>
      <RuleGroup name="TLSish_Ports" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <DestinationPort condition="is">8443</DestinationPort>
      </RuleGroup>
      <RuleGroup name="TLSish_Ports" groupRelation="and">
        <Initiated condition="is">true</Initiated>
        <DestinationPort condition="is">9443</DestinationPort>
      </RuleGroup>
    </NetworkConnect>

  </EventFiltering>
</Sysmon>
