#!/usr/bin/env python3
import sys, os, time, json, re

# --- CONFIG ---
EVE_PATH = "/var/log/suricata/eve.json"   # adjust if different
WATCHLIST = "/etc/suricata/ja3_watchlist.txt"  # one md5 per line (lowercase)
# ---------------

def load_watchlist(path):
    s = set()
    try:
        with open(path) as f:
            for ln in f:
                ln = ln.strip().lower()
                if re.fullmatch(r"[0-9a-f]{32}", ln):
                    s.add(ln)
    except Exception:
        pass
    return s

def tail_eve(path):
    """Simple tail -F: reopen on rotation."""
    pos = 0
    fh = None
    ino = None
    while True:
        try:
            st = os.stat(path)
            if fh is None or st.st_ino != ino:
                if fh: fh.close()
                fh = open(path, "r", buffering=1)
                ino = st.st_ino
                fh.seek(0, os.SEEK_END)
        except FileNotFoundError:
            time.sleep(1); continue

        line = fh.readline()
        if not line:
            time.sleep(0.2)
            continue
        yield line

def emit_alert(ts, msg):
    # audispd will forward stdout to syslog/journald
    print(f"{ts} AUDIT-ALERT JA3 match: {msg}", flush=True)

def main():
    wl = load_watchlist(WATCHLIST)
    last_reload = time.time()

    for line in tail_eve(EVE_PATH):
        # hot-reload watchlist every 30s
        if time.time() - last_reload > 30:
            wl = load_watchlist(WATCHLIST)
            last_reload = time.time()

        try:
            ev = json.loads(line)
        except Exception:
            continue

        if ev.get("event_type") != "tls":
            continue

        # Suricata variants: .tls.ja3.hash OR .ja3.hash (version-dependent)
        ja3 = (
            ev.get("tls", {}).get("ja3", {}).get("hash") or
            ev.get("ja3", {}).get("hash")
        )
        if not ja3: 
            continue
        j = ja3.lower()

        if j in wl:
            ts = ev.get("timestamp", time.strftime("%Y-%m-%dT%H:%M:%S%z"))
            s = ev.get("src_ip", "?"); sp = ev.get("src_port", "?")
            d = ev.get("dest_ip", "?"); dp = ev.get("dest_port", "?")
            sni = ev.get("tls", {}).get("sni") or ev.get("sni")
            emit_alert(ts, f"ja3={j} src={s}:{sp} dst={d}:{dp} sni={sni or '-'}")
            # NOTE: For PID/EXE correlation, join in SIEM on near-time
            # with audit records keyed user_connect/user_exec.

if __name__ == "__main__":
    main()
